<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>School App Store</title>

    <script>
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const currentAppId = urlParams.get('id');
            if (currentAppId) {
                // Determine if it is a numeric ID (Real App Store) or Custom
                // The meta tag only works for real App Store IDs (numbers).
                if (/^\d+$/.test(currentAppId)) {
                    document.write('<meta name="apple-itunes-app" content="app-id=' + currentAppId + '">');
                } else {
                    console.log("Custom App ID detected. Smart Banner skipped (only works for App Store IDs).");
                }
            }
        })();
    </script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* -----------------------------------------------------------------------------
           3.1 GLOBAL VARIABLES & RESET
           -----------------------------------------------------------------------------
        */
        :root {
            /* Apple Color Palette */
            --ios-blue: #007AFF;
            --ios-blue-dim: #005ecb;
            --ios-gray-bg: #F2F2F7;
            --ios-white: #FFFFFF;
            --ios-text: #000000;
            --ios-text-sec: #8E8E93;
            --ios-border: #C6C6C8;
            --ios-red: #FF3B30;
            --ios-green: #34C759;
            --ios-orange: #FF9500;

            /* MDM Theme Specifics */
            --mdm-bg-backdrop: #1c1c1e; /* Dark backdrop for desktop */
            --mdm-window-bg: #FFFFFF;
            --mdm-sidebar-width: 240px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--ios-gray-bg);
            color: var(--ios-text);
            height: 100vh;
            overflow: hidden; /* We handle scrolling internally */
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { display: flex; flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .pointer { cursor: pointer; }

        /* Button Resets */
        button {
            border: none;
            background: none;
            cursor: pointer;
            font-family: inherit;
        }

        /* -----------------------------------------------------------------------------
           3.2 LOADING SCREEN
           -----------------------------------------------------------------------------
        */
        #global-loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #fff;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }
        
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--ios-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* -----------------------------------------------------------------------------
           3.3 MDM THEME (DESKTOP WINDOW STYLE)
           -----------------------------------------------------------------------------
           Active when body has class "theme-mdm"
        */
        body.theme-mdm {
            background-color: var(--mdm-bg-backdrop);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mdm-window {
            display: none; /* Hidden unless theme active */
            width: 95%;
            max-width: 1200px;
            height: 90vh;
            background: var(--mdm-window-bg);
            border-radius: 12px;
            box-shadow: 0 40px 80px rgba(0,0,0,0.6);
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        body.theme-mdm .mdm-window { display: flex; }

        /* MDM Header */
        .mdm-header {
            height: 60px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            align-items: center;
            padding: 0 20px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            justify-content: space-between;
            flex-shrink: 0;
        }

        .mdm-brand {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mdm-controls {
            display: flex;
            gap: 10px;
        }

        .mdm-btn {
            padding: 6px 12px;
            border: 1px solid #d1d1d6;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--ios-blue);
            background: #fff;
            transition: 0.2s;
        }
        .mdm-btn:hover { background: #f2f7ff; border-color: var(--ios-blue); }

        .mdm-search {
            background: #f1f1f2;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            width: 220px;
            font-size: 14px;
        }
        .mdm-search:focus { outline: 2px solid var(--ios-blue); background: white; }

        /* MDM Body Content */
        .mdm-body {
            flex: 1;
            overflow: hidden;
            position: relative;
            background: #fff;
        }

        /* MDM Table Styles */
        .app-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .app-table thead th {
            text-align: left;
            padding: 12px 20px;
            border-bottom: 1px solid #eee;
            background: #f9f9f9;
            color: #888;
            font-size: 12px;
            text-transform: uppercase;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .app-table tbody tr {
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: background 0.1s;
        }
        .app-table tbody tr:hover { background: #f0f0f0; }

        .app-table td {
            padding: 12px 20px;
            vertical-align: middle;
            font-size: 14px;
        }

        .table-icon {
            width: 42px; height: 42px;
            border-radius: 10px;
            background-color: #eee;
            background-size: cover;
            background-position: center;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .status-pill {
            background: #f2f2f7;
            color: var(--ios-blue);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        /* -----------------------------------------------------------------------------
           3.4 CLASSIC THEME (MOBILE PHONE STYLE)
           -----------------------------------------------------------------------------
           Active when class "theme-mdm" is NOT present on body.
        */
        .classic-ui {
            display: none;
            flex-direction: column;
            height: 100%;
            background: #fff;
        }
        body:not(.theme-mdm) .classic-ui { display: flex; }

        .classic-nav {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .classic-title { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
        
        .classic-list {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .classic-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #efeff4;
            cursor: pointer;
        }
        .classic-item:active { background: #e5e5e5; }

        .classic-icon {
            width: 60px; height: 60px;
            border-radius: 14px;
            background: #eee;
            background-size: cover;
            background-position: center;
            border: 1px solid rgba(0,0,0,0.1);
            margin-right: 15px;
        }

        .get-btn {
            background: #f0f0f8;
            color: var(--ios-blue);
            font-weight: 700;
            font-size: 13px;
            padding: 6px 20px;
            border-radius: 18px;
            border: none;
        }

        /* -----------------------------------------------------------------------------
           3.5 APP DETAIL VIEW (FULL OVERLAY)
           -----------------------------------------------------------------------------
           This view takes over the MDM window or the Mobile Screen.
           This is the "New Page" the user requested.
        */
        .detail-view {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #fff;
            z-index: 100;
            overflow-y: auto;
            display: none; /* Hidden by default */
            flex-direction: column;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* MDM specific adjustment for detail view to sit below header */
        body.theme-mdm .detail-view { top: 0; z-index: 50; }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .detail-nav {
            padding: 15px 20px;
            color: var(--ios-blue);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            position: sticky;
            top: 0;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            z-index: 10;
            border-bottom: 1px solid transparent;
        }
        .detail-nav.scrolled { border-bottom-color: #eee; }

        .detail-content {
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            padding: 0 20px 40px 20px;
        }

        .app-header {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            margin-bottom: 30px;
        }

        .app-header-icon {
            width: 118px; height: 118px;
            border-radius: 26px;
            background: #eee;
            background-size: cover;
            background-position: center;
            border: 1px solid rgba(0,0,0,0.1);
            flex-shrink: 0;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .app-header-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .app-title { font-size: 24px; font-weight: 700; margin: 0 0 5px 0; line-height: 1.2; }
        .app-subtitle { font-size: 15px; color: #888; margin: 0 0 15px 0; }

        .install-btn-lg {
            background: var(--ios-blue);
            color: white;
            font-weight: 700;
            padding: 10px 30px;
            border-radius: 20px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            width: fit-content;
            font-size: 14px;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
            padding: 15px 0;
            margin-bottom: 25px;
        }
        .stat-item { text-align: center; flex: 1; border-right: 1px solid #eee; }
        .stat-item:last-child { border: none; }
        .stat-label { font-size: 11px; color: #aaa; font-weight: 600; margin-bottom: 4px; text-transform: uppercase; }
        .stat-value { font-size: 20px; font-weight: 700; color: #333; }
        .stat-sub { font-size: 12px; color: #888; }

        .section-box { margin-bottom: 30px; }
        .section-header { font-size: 20px; font-weight: 700; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: flex-end; }
        .whats-new-card { background: #f2f2f7; padding: 20px; border-radius: 12px; }
        .version-line { font-size: 14px; color: #888; margin-bottom: 8px; }
        .release-notes { font-size: 15px; line-height: 1.5; color: #333; }
        .desc-text { font-size: 15px; line-height: 1.6; color: #333; }

        /* Comments / Ratings */
        .rating-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        .rating-top { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .rating-user { font-weight: 700; font-size: 14px; }
        .rating-date { font-size: 12px; color: #999; }
        .rating-stars { color: var(--ios-orange); font-size: 12px; letter-spacing: 1px; margin-bottom: 6px; }
        .rating-text { font-size: 14px; line-height: 1.4; color: #444; }

        .input-area {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        .comment-box { width: 100%; border: none; font-size: 14px; resize: none; outline: none; }

        /* -----------------------------------------------------------------------------
           3.6 ADMIN PANELS (DASHBOARD & LOGIN)
           -----------------------------------------------------------------------------
        */
        .admin-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f5f5f7;
            z-index: 5000;
            display: none;
            overflow-y: auto;
        }

        .admin-container {
            max-width: 600px;
            margin: 40px auto;
            padding: 20px;
        }

        .admin-card {
            background: #fff;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .admin-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            font-size: 15px;
            background: #fafafa;
            margin-bottom: 12px;
        }
        .admin-input:focus { background: #fff; border-color: var(--ios-blue); outline: none; }

        .admin-btn-full {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            background: var(--ios-blue);
            color: white;
            font-size: 16px;
            font-weight: 600;
        }
        .bg-red { background: var(--ios-red) !important; }

        /* Admin App List Item */
        .admin-list-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .admin-list-row:last-child { border-bottom: none; }
        
        .trash-icon {
            color: var(--ios-red);
            font-size: 20px;
            padding: 8px;
            background: rgba(255, 59, 48, 0.1);
            border-radius: 6px;
        }

    </style>
</head>
<body class="theme-mdm"> <div id="global-loader">
        <div class="spinner"></div>
        <div style="color:#888; font-size:14px; font-weight:500;">Loading App Store...</div>
    </div>

    <div class="mdm-window">
        <div class="mdm-header">
            <div class="mdm-brand">
                <i class="ph ph-squares-four" style="font-size:24px; color:var(--ios-blue);"></i>
                <span>School MDM</span>
            </div>
            <div class="mdm-controls">
                <input type="text" class="mdm-search" placeholder="Search apps..." onkeyup="handleSearch(this.value)">
                <button class="mdm-btn" onclick="location.reload()">
                    <i class="ph ph-arrows-clockwise"></i>
                </button>
                <button class="mdm-btn" onclick="openAdminLink()">
                    <i class="ph ph-gear"></i>
                </button>
            </div>
        </div>

        <div class="mdm-body">
            <div id="mdm-list-view" style="height:100%; overflow-y:auto;">
                <table class="app-table">
                    <thead>
                        <tr>
                            <th width="70">Icon</th>
                            <th>Application</th>
                            <th>Version</th>
                            <th>Size</th>
                            <th align="right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="mdm-table-body">
                        </tbody>
                </table>
                <div id="mdm-empty" style="padding:40px; text-align:center; color:#999; display:none;">
                    No apps found matching your search.
                </div>
            </div>

            <div id="mdm-detail-view" class="detail-view">
                </div>
        </div>
    </div>


    <div class="classic-ui">
        <div class="classic-nav">
            <div class="classic-title">FemDihShop</div>
            <div style="color:var(--ios-blue); font-weight:600;" onclick="openAdminLink()">Admin</div>
        </div>
        
        <div class="classic-list" id="classic-list-body">
            </div>

        <div id="mobile-detail-view" class="detail-view" style="z-index: 2000;">
            </div>
    </div>


    <div id="admin-login-screen" class="admin-overlay">
        <div class="flex-col items-center justify-between" style="height:100%; padding-top:100px;">
            <div class="admin-container" style="text-align:center;">
                <div style="background:#e5e5ea; width:80px; height:80px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; margin-bottom:20px;">
                    <i class="ph ph-lock-key" style="font-size:32px; color:#555;"></i>
                </div>
                <h2>Restricted Access</h2>
                <p style="color:#888; margin-bottom:30px;">Enter Manager PIN to continue.</p>
                <input type="password" id="pin-input" class="admin-input" style="text-align:center; font-size:24px; letter-spacing:5px;" placeholder="••••" maxlength="4">
                <button class="admin-btn-full" style="margin-top:10px;" onclick="attemptLogin()">Unlock Dashboard</button>
            </div>
            <div style="padding-bottom:40px;">
                <button onclick="exitAdmin()" style="color:#888;">Back to Store</button>
            </div>
        </div>
    </div>

    <div id="admin-dashboard-screen" class="admin-overlay">
        <div style="background:#fff; padding:15px 20px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:700; font-size:18px;">Admin Console</div>
            <div style="color:var(--ios-red); cursor:pointer;" onclick="exitAdmin()">Logout</div>
        </div>

        <div class="admin-container">
            
            <div class="admin-card">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px;">
                    <div style="background:var(--ios-green); width:30px; height:30px; border-radius:6px; display:flex; align-items:center; justify-content:center; color:white;"><i class="ph ph-plus-bold"></i></div>
                    <h3 style="margin:0;">Add Application</h3>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <input id="new-name" class="admin-input" placeholder="App Name (e.g. Minecraft)">
                    <input id="new-dev" class="admin-input" placeholder="Developer Name">
                </div>
                
                <div style="background:#f0f8ff; padding:15px; border-radius:8px; border:1px solid #cce5ff; margin-bottom:15px;">
                    <label style="font-size:11px; font-weight:700; color:var(--ios-blue); text-transform:uppercase;">Crucial For Smart Banner</label>
                    <input id="new-id" class="admin-input" placeholder="Apple App ID (e.g. 544007664)" style="margin-top:5px; margin-bottom:5px;">
                    <div style="font-size:11px; color:#555; line-height:1.4;">
                        * Find this in the App Store URL (e.g. id123456789). Use numbers only. 
                        We will auto-fetch Icon, Description & Ratings if valid.
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <input id="new-ver" class="admin-input" placeholder="Version (1.0)">
                    <input id="new-size" class="admin-input" placeholder="Size (200 MB)">
                </div>

                <input id="new-scheme" class="admin-input" placeholder="URL Scheme (optional, e.g. zoom://)">
                <input id="new-icon" class="admin-input" placeholder="Custom Icon URL (Optional)">
                
                <button class="admin-btn-full" onclick="addAppToDB()">Save Application</button>
            </div>

            <div class="admin-card">
                <h3 style="margin-top:0;">Manage Apps</h3>
                <p style="color:#888; font-size:13px;">Tap trash icon to delete.</p>
                
                <div id="admin-app-list-container" style="max-height:400px; overflow-y:auto; border:1px solid #f0f0f0; border-radius:8px; padding:0 10px;">
                    <div style="padding:20px; text-align:center; color:#ccc;">Loading List...</div>
                </div>
            </div>

            <div class="admin-card">
                <h3 style="margin-top:0;">Reports</h3>
                <div id="admin-reports-container" style="font-size:13px;">
                    Loading...
                </div>
            </div>

        </div>
    </div>


    <script>
        // ---------------------------------------------------------
        // 4.1 CONFIGURATION
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyDGi1smvUpUmw76Qrc0XWLRDDgpfEZAEDA",
            authDomain: "schoolappdownload.firebaseapp.com",
            databaseURL: "https://schoolappdownload-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "schoolappdownload",
            storageBucket: "schoolappdownload.firebasestorage.app",
            messagingSenderId: "386507255292",
            appId: "1:386507255292:web:c20e841b39538c43251679"
        };
        
        // Init Firebase
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Global Variables
        let allApps = []; // Stores the raw data
        const ADMIN_PIN = "1234";

        // ---------------------------------------------------------
        // 4.2 INITIALIZATION & ROUTING
        // ---------------------------------------------------------
        window.onload = function() {
            // Theme Detection: If mobile width, switch to classic
            const isMobileWidth = window.innerWidth < 768;
            if (isMobileWidth) {
                document.body.classList.remove('theme-mdm');
            }

            // URL Param Check
            const params = new URLSearchParams(window.location.search);
            const page = params.get('page');
            const id = params.get('id');

            if (page === 'admin') {
                // Direct Admin Access
                document.getElementById('global-loader').style.display = 'none';
                document.getElementById('admin-login-screen').style.display = 'block';
                // We still fetch data in background
                fetchData();
            } else {
                // Normal Store Access
                fetchData(id); // Pass ID to handle deep linking
            }
        };

        // Fetch Data from Firebase
        function fetchData(targetAppId) {
            db.ref('apps').on('value', (snapshot) => {
                const val = snapshot.val();
                allApps = val ? Object.values(val) : [];

                // Render Lists
                renderMDMList(allApps);
                renderClassicList(allApps);
                
                // Update Admin List if it's visible
                renderAdminListInternal();

                // Hide Loader
                document.getElementById('global-loader').style.display = 'none';

                // If URL has ?id=XYZ, open that app immediately
                if (targetAppId) {
                    openAppDetail(targetAppId);
                }
            });
        }

        // ---------------------------------------------------------
        // 4.3 NAVIGATION LOGIC
        // ---------------------------------------------------------
        
        /**
         * RELOAD PAGE WITH ID
         * This satisfies "make a new page and add the app banner".
         * The only way to add the banner is a full reload with the meta tag.
         */
        function navigateToApp(id) {
            window.location.href = "?id=" + id;
        }

        /**
         * GO HOME
         * Clears the ?id= parameter and reloads to remove banner
         */
        function goHome() {
            window.location.href = window.location.pathname;
        }

        /**
         * OPEN DETAIL VIEW (Client Side Rendering)
         * Called automatically after reload if ?id= exists
         */
        async function openAppDetail(id) {
            const app = allApps.find(a => a.id === id);
            
            // If ID exists in URL but not in DB (deleted app), go home
            if (!app) {
                console.warn("App ID not found in database.");
                return; // or goHome();
            }

            // Fetch Real iTunes Data if it's a numeric ID
            let appleData = null;
            if (/^\d+$/.test(app.id)) {
                try {
                    const res = await fetch(`https://itunes.apple.com/lookup?id=${app.id}`);
                    const json = await res.json();
                    if (json.results && json.results.length > 0) {
                        appleData = json.results[0];
                    }
                } catch (e) { console.error("Apple API Error", e); }
            }

            // Render HTML
            const detailHTML = buildDetailHTML(app, appleData);

            // Inject into correct container based on theme
            const isMDM = document.body.classList.contains('theme-mdm');
            const containerId = isMDM ? 'mdm-detail-view' : 'mobile-detail-view';
            const listViewId = isMDM ? 'mdm-list-view' : 'classic-list-body'; // Mobile overlays entire screen anyway
            
            const container = document.getElementById(containerId);
            container.innerHTML = detailHTML;
            container.style.display = 'flex'; // Show detail
            
            if(isMDM) {
                document.getElementById('mdm-list-view').style.display = 'none'; // Hide list in MDM
            }

            // Load Comments
            loadComments(app.id);
        }

        // ---------------------------------------------------------
        // 4.4 HTML GENERATORS
        // ---------------------------------------------------------
        
        function buildDetailHTML(app, appleData) {
            // Data Fallbacks
            const d = appleData || {};
            const icon = d.artworkUrl512 || app.icon;
            const name = app.name;
            const developer = d.artistName || app.company || "Unknown Developer";
            const desc = d.description ? d.description.replace(/\n/g, '<br>') : (app.desc || "No description provided.");
            const version = d.version || app.version || "1.0";
            const rating = d.averageUserRating ? d.averageUserRating.toFixed(1) : "4.5";
            const age = d.contentAdvisoryRating || "4+";
            const releaseNotes = d.releaseNotes ? d.releaseNotes.replace(/\n/g, '<br>') : "Bug fixes and performance improvements.";

            // Icon CSS
            let iconStyle = '';
            let iconInner = '';
            if (icon && icon.includes('http')) {
                iconStyle = `background-image: url('${icon}');`;
            } else {
                iconStyle = `background-color: ${app.color || '#999'};`;
                iconInner = `<div style="display:flex; justify-content:center; align-items:center; height:100%; color:white; font-size:40px; font-weight:700;">${name[0]}</div>`;
            }

            return `
                <div class="detail-nav" onclick="goHome()">
                    <i class="ph ph-caret-left-bold"></i> Back
                </div>
                
                <div class="detail-content">
                    <div class="app-header">
                        <div class="app-header-icon" style="${iconStyle}">${iconInner}</div>
                        <div class="app-header-info">
                            <div class="app-title">${name}</div>
                            <div class="app-subtitle">${developer}</div>
                            <a href="${app.scheme || '#'}" class="install-btn-lg">OPEN APP</a>
                        </div>
                    </div>

                    <div class="stats-row">
                        <div class="stat-item">
                            <div class="stat-value">${rating} ★</div>
                            <div class="stat-sub">Ratings</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${age}</div>
                            <div class="stat-sub">Age</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${version}</div>
                            <div class="stat-sub">Version</div>
                        </div>
                    </div>

                    <div class="section-box">
                        <div class="section-header">What's New</div>
                        <div class="whats-new-card">
                            <div class="version-line">Version ${version}</div>
                            <div class="release-notes">${releaseNotes}</div>
                        </div>
                    </div>

                    <div class="section-box">
                        <div class="section-header">About</div>
                        <div class="desc-text">${desc}</div>
                    </div>

                    <div class="section-box">
                        <div class="section-header">Reviews</div>
                        
                        <div id="comments-list-${app.id}">
                            <div style="color:#999; font-style:italic;">Loading reviews...</div>
                        </div>

                        <div class="input-area">
                            <div style="font-weight:600; margin-bottom:10px;">Write a Review as User</div>
                            <textarea id="comment-box-${app.id}" class="comment-box" rows="3" placeholder="Tap to write..."></textarea>
                            <div style="text-align:right; margin-top:10px;">
                                <button onclick="submitComment('${app.id}')" style="background:var(--ios-blue); color:white; padding:8px 16px; border-radius:20px; font-weight:600;">Submit</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ---------------------------------------------------------
        // 4.5 RENDER LISTS
        // ---------------------------------------------------------
        
        function renderMDMList(apps) {
            const tbody = document.getElementById('mdm-table-body');
            tbody.innerHTML = '';
            
            if(apps.length === 0) {
                document.getElementById('mdm-empty').style.display = 'block';
                return;
            }
            document.getElementById('mdm-empty').style.display = 'none';

            apps.forEach(app => {
                const tr = document.createElement('tr');
                tr.onclick = () => navigateToApp(app.id); // Triggers Reload

                // Icon Logic
                let iconHtml = '';
                if(app.icon && app.icon.includes('http')) {
                    iconHtml = `<div class="table-icon" style="background-image:url('${app.icon}')"></div>`;
                } else {
                    iconHtml = `<div class="table-icon" style="background-color:${app.color||'#ccc'}; display:flex; align-items:center; justify-content:center; color:white; font-weight:700;">${app.name[0]}</div>`;
                }

                tr.innerHTML = `
                    <td>${iconHtml}</td>
                    <td style="font-weight:500; font-size:15px;">${app.name}</td>
                    <td style="color:#666;">${app.version || '1.0'}</td>
                    <td style="color:#666;">${app.size || 'N/A'}</td>
                    <td align="right"><span class="status-pill">OPEN</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderClassicList(apps) {
            const list = document.getElementById('classic-list-body');
            list.innerHTML = '';

            apps.forEach(app => {
                const div = document.createElement('div');
                div.className = 'classic-item';
                div.onclick = () => navigateToApp(app.id); // Triggers Reload

                let iconStyle = (app.icon && app.icon.includes('http')) 
                    ? `background-image:url('${app.icon}')` 
                    : `background-color:${app.color||'#ccc'}; display:flex; align-items:center; justify-content:center; color:#fff; font-size:24px; font-weight:700;`;
                
                let iconInner = (app.icon && app.icon.includes('http')) ? '' : app.name[0];

                div.innerHTML = `
                    <div class="classic-icon" style="${iconStyle}">${iconInner}</div>
                    <div style="flex:1">
                        <div style="font-weight:600; font-size:16px; margin-bottom:2px;">${app.name}</div>
                        <div style="font-size:13px; color:#8e8e93;">${app.company || 'Education'}</div>
                    </div>
                    <button class="get-btn">OPEN</button>
                `;
                list.appendChild(div);
            });
        }

        // ---------------------------------------------------------
        // 4.6 COMMENTS SYSTEM
        // ---------------------------------------------------------
        function loadComments(appId) {
            const container = document.getElementById(`comments-list-${appId}`);
            if(!container) return;

            db.ref('comments/' + appId).on('value', (snap) => {
                const val = snap.val();
                if(!val) {
                    container.innerHTML = `<div style="padding:20px; text-align:center; color:#ccc;">No reviews yet. Be the first!</div>`;
                    return;
                }

                let html = '';
                // Convert object to array, reverse to show newest first
                Object.values(val).reverse().forEach(c => {
                    html += `
                        <div class="rating-card">
                            <div class="rating-top">
                                <span class="rating-user">${c.user || 'User'}</span>
                                <span class="rating-date">${new Date(c.date).toLocaleDateString()}</span>
                            </div>
                            <div class="rating-stars">★★★★★</div>
                            <div class="rating-text">${c.text}</div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            });
        }

        function submitComment(appId) {
            const box = document.getElementById(`comment-box-${appId}`);
            const text = box.value.trim();
            if(!text) return alert("Please type a review.");

            db.ref('comments/' + appId).push({
                user: "User", // As requested: "Make everyone User"
                text: text,
                date: Date.now()
            });

            box.value = ""; // Clear input
        }

        // ---------------------------------------------------------
        // 4.7 ADMIN LOGIC (FIXED)
        // ---------------------------------------------------------
        
        function openAdminLink() {
            window.location.href = "?page=admin";
        }

        function exitAdmin() {
            window.location.href = window.location.pathname; // Go back to root
        }

        function attemptLogin() {
            const input = document.getElementById('pin-input').value;
            if(input === ADMIN_PIN) {
                document.getElementById('admin-login-screen').style.display = 'none';
                document.getElementById('admin-dashboard-screen').style.display = 'block';
                renderAdminListInternal(); // Ensure list is rendered on login
                loadReports();
            } else {
                alert("Incorrect PIN");
                document.getElementById('pin-input').value = "";
            }
        }

        // THIS WAS THE BUGGY PART - NOW FIXED
        function renderAdminListInternal() {
            const container = document.getElementById('admin-app-list-container');
            if(!container) return; // Guard clause if element doesn't exist

            if(allApps.length === 0) {
                container.innerHTML = `<div style="padding:20px; text-align:center;">No apps found in database. Add one!</div>`;
                return;
            }

            container.innerHTML = '';
            allApps.forEach(app => {
                const row = document.createElement('div');
                row.className = 'admin-list-row';
                
                // Safe icon display
                const iconSrc = (app.icon && app.icon.startsWith('http')) ? app.icon : '';
                const imgTag = iconSrc 
                    ? `<img src="${iconSrc}" style="width:32px; height:32px; border-radius:6px;">` 
                    : `<div style="width:32px; height:32px; background:#ccc; border-radius:6px;"></div>`;

                row.innerHTML = `
                    <div style="display:flex; align-items:center; gap:12px;">
                        ${imgTag}
                        <div>
                            <div style="font-weight:600; font-size:14px;">${app.name}</div>
                            <div style="font-size:11px; color:#888;">ID: ${app.id}</div>
                        </div>
                    </div>
                    <div class="trash-icon" onclick="deleteApp('${app.id}', '${app.name}')">
                        <i class="ph ph-trash"></i>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function addAppToDB() {
            const id = document.getElementById('new-id').value.trim();
            const name = document.getElementById('new-name').value.trim();
            
            if(!id || !name) return alert("App ID and Name are required.");

            const data = {
                id: id,
                name: name,
                company: document.getElementById('new-dev').value || "Education",
                version: document.getElementById('new-ver').value || "1.0",
                size: document.getElementById('new-size').value,
                scheme: document.getElementById('new-scheme').value,
                icon: document.getElementById('new-icon').value,
                added: Date.now()
            };

            db.ref('apps/' + id).set(data, (error) => {
                if(error) alert("Error: " + error.message);
                else {
                    alert("App Added Successfully!");
                    // Clear Fields
                    document.getElementById('new-id').value = "";
                    document.getElementById('new-name').value = "";
                    renderAdminListInternal(); // Refresh list immediately
                }
            });
        }

        function deleteApp(id, name) {
            if(confirm(`Are you sure you want to delete "${name}"? This cannot be undone.`)) {
                db.ref('apps/' + id).remove()
                    .then(() => {
                        alert("Deleted.");
                        // The on('value') listener will automatically refresh the list
                    })
                    .catch(err => alert(err.message));
            }
        }

        function loadReports() {
            const c = document.getElementById('admin-reports-container');
            db.ref('requests').on('value', (snap) => {
                const val = snap.val();
                if(!val) {
                    c.innerHTML = "No active reports.";
                    return;
                }
                c.innerHTML = '';
                Object.entries(val).forEach(([k, v]) => {
                    const d = document.createElement('div');
                    d.style.padding = "10px";
                    d.style.borderBottom = "1px solid #eee";
                    d.innerHTML = `
                        <div style="margin-bottom:4px;">"${v.msg}"</div>
                        <div style="display:flex; justify-content:space-between; color:#999; font-size:11px;">
                            <span>${new Date(v.date).toLocaleDateString()}</span>
                            <span style="color:red; cursor:pointer;" onclick="db.ref('requests/${k}').remove()">Dismiss</span>
                        </div>
                    `;
                    c.appendChild(d);
                });
            });
        }

        // ---------------------------------------------------------
        // 4.8 SEARCH UTILITY
        // ---------------------------------------------------------
        function handleSearch(query) {
            const q = query.toLowerCase();
            const filtered = allApps.filter(a => a.name.toLowerCase().includes(q));
            
            // Re-render only the main lists
            renderMDMList(filtered);
            renderClassicList(filtered);
        }

    </script>
</body>
</html>
