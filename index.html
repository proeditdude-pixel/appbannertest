<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FemDihShop</title>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const currentAppId = urlParams.get('id');
        if (currentAppId) {
            document.write('<meta name="apple-itunes-app" content="app-id=' + currentAppId + '">');
        }
    </script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- STYLES --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background: #fff; color: #1c1c1e; -webkit-tap-highlight-color: transparent; }
        
        /* Header */
        header { padding: 0 15px; border-bottom: 1px solid #e5e5ea; background: rgba(255,255,255,0.95); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(20px); display: flex; align-items: center; justify-content: space-between; height: 50px; }
        h1 { font-size: 18px; font-weight: 600; flex-grow: 1; text-align: center; }
        .nav-btn { color: #007AFF; font-size: 16px; cursor: pointer; min-width: 60px; display: flex; align-items: center; text-decoration: none; }
        .nav-btn.right { justify-content: flex-end; font-weight: 600; }
        .hidden { visibility: hidden; }

        /* Views */
        #app-list-view, #app-detail-view, #request-view, #admin-login-view, #admin-dashboard-view { padding: 20px; display: none; }
        
        /* List Item */
        .app-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #efeff4; cursor: pointer; }
        .list-icon { width: 54px; height: 54px; border-radius: 12px; margin-right: 15px; background-size: cover; background-position: center; background-color: #eee; border: 1px solid rgba(0,0,0,0.1); }
        .info { flex-grow: 1; }
        .title { font-weight: 600; font-size: 16px; }
        .subtitle { color: #8e8e93; font-size: 13px; }
        .get-btn { background: #f0f0f8; color: #007AFF; font-weight: 700; padding: 6px 18px; border-radius: 16px; border: none; font-size: 13px; cursor: pointer; }

        /* Detail View */
        .hero-icon { width: 110px; height: 110px; border-radius: 24px; margin: 0 auto 20px; background-size: cover; background-position: center; background-color: #eee; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .big-btn { background: #007AFF; color: white; border: none; padding: 14px; border-radius: 14px; font-weight: 600; width: 100%; font-size: 16px; margin-top: 20px; cursor: pointer; }
        .desc-box { background: #f2f2f7; padding: 20px; border-radius: 14px; margin-top: 25px; }

        /* Forms */
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; background: #f9f9f9; }
        .submit-btn { background: #007AFF; color: white; border: none; padding: 15px; border-radius: 14px; width: 100%; font-weight: 600; font-size: 16px; margin-top: 10px; cursor: pointer; }
        .admin-card { background: white; border: 1px solid #eee; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <header>
        <div id="btn-left" class="nav-btn left hidden" onclick="goHome()">Back</div>
        <h1 id="page-title">FemDihShop</h1>
        <div id="btn-right" class="nav-btn right" onclick="goRequest()">Request</div>
    </header>

    <div id="loading" style="text-align:center; padding:50px; color:#888;">Loading...</div>

    <div id="app-list-view"></div>

    <div id="app-detail-view">
        <div id="detail-icon" class="hero-icon"></div>
        <h2 id="detail-name" style="text-align:center; margin:0 0 5px;"></h2>
        <p id="detail-company" style="text-align:center; color:#8e8e93; margin:0;"></p>
        <button id="detail-open-btn" class="big-btn">OPEN APP</button>
        <div class="desc-box">
            <h3 style="margin:0 0 10px;">About</h3>
            <p id="detail-desc" style="line-height:1.5; color:#333; margin:0;"></p>
        </div>
    </div>

    <div id="request-view">
        <h2>Request App</h2>
        <p style="color:#888;">What should we add next?</p>
        <textarea id="req-msg" rows="5" placeholder="e.g. Please add Fortnite..."></textarea>
        <button class="submit-btn" onclick="sendFeedback()">Send Request</button>
    </div>

    <div id="admin-login-view">
        <h2 style="text-align:center; margin-top:50px;">Manager Login</h2>
        <input type="password" id="admin-pin" placeholder="PIN" style="text-align:center; letter-spacing: 5px;">
        <button class="submit-btn" onclick="checkLogin()">Unlock</button>
    </div>

    <div id="admin-dashboard-view">
        <h2>Dashboard</h2>
        
        <div class="admin-card">
            <h3>Add New App</h3>
            <input id="new-name" placeholder="Name (e.g. Minecraft)">
            <input id="new-comp" placeholder="Company (e.g. Mojang)">
            <input id="new-id" placeholder="App ID (e.g. 479516143)">
            <input id="new-scheme" placeholder="Scheme (e.g. minecraft://)">
            <input id="new-desc" placeholder="Description">
            <input id="new-color" placeholder="Color Hex (#000) or Image URL">
            <button class="submit-btn" style="background:#34c759" onclick="addApp()">Save App</button>
        </div>

        <div class="admin-card">
            <h3 style="color:red">Delete App</h3>
            <input id="del-name" placeholder="Exact App Name">
            <button class="submit-btn" style="background:#ff3b30" onclick="deleteApp()">Delete</button>
        </div>
    </div>

    <script>
        // --- 1. YOUR FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDGi1smvUpUmw76Qrc0XWLRDDgpfEZAEDA",
            authDomain: "schoolappdownload.firebaseapp.com",
            databaseURL: "https://schoolappdownload-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "schoolappdownload",
            storageBucket: "schoolappdownload.firebasestorage.app",
            messagingSenderId: "386507255292",
            appId: "1:386507255292:web:c20e841b39538c43251679",
            measurementId: "G-HVZLQ96B6P"
        };

        // Initialize Firebase (Standard CDN method)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();
        
        // ADMIN PIN CODE (You can change this)
        const ADMIN_PIN = "1234"; 

        let myApps = [];

        // --- 2. FETCH APPS (Realtime) ---
        db.ref('apps').on('value', (snapshot) => {
            const data = snapshot.val();
            // Convert Firebase object to Array
            myApps = data ? Object.values(data) : [];
            
            document.getElementById('loading').style.display = 'none';
            handleRouting(); // Refresh the screen
        });

        // --- 3. PAGE NAVIGATION ---
        function handleRouting() {
            const params = new URLSearchParams(window.location.search);
            const page = params.get('page');
            const id = params.get('id');

            // Hide all sections first
            ['app-list-view', 'app-detail-view', 'request-view', 'admin-login-view', 'admin-dashboard-view']
                .forEach(divId => document.getElementById(divId).style.display = 'none');
            
            // Get Header Elements
            const btnLeft = document.getElementById('btn-left');
            const btnRight = document.getElementById('btn-right');
            const title = document.getElementById('page-title');

            if (page === 'admin') {
                // Admin Login
                document.getElementById('admin-login-view').style.display = 'block';
                title.innerText = "Admin Access";
                btnLeft.className = "nav-btn left";
                btnRight.className = "nav-btn right hidden";
            } 
            else if (page === 'request') {
                // Request Page
                document.getElementById('request-view').style.display = 'block';
                title.innerText = "Feedback";
                btnLeft.className = "nav-btn left";
                btnRight.className = "nav-btn right hidden";
            }
            else if (id) {
                // Detail Page
                const app = myApps.find(a => a.id === id);
                if (app) {
                    document.getElementById('app-detail-view').style.display = 'block';
                    title.innerText = "Details";
                    btnLeft.className = "nav-btn left";
                    btnRight.className = "nav-btn right hidden";
                    
                    // Fill Info
                    document.getElementById('detail-name').innerText = app.name;
                    document.getElementById('detail-company').innerText = app.company;
                    document.getElementById('detail-desc').innerText = app.desc;
                    
                    const icon = document.getElementById('detail-icon');
                    if(app.color && app.color.includes('http')) {
                        icon.style.backgroundImage = `url('${app.color}')`;
                        icon.style.background = 'none'; // reset solid color
                    } else {
                        icon.style.background = app.color;
                    }
                    
                    document.getElementById('detail-open-btn').onclick = () => window.location.href = app.scheme;
                }
            } 
            else {
                // Main Shop List
                document.getElementById('app-list-view').style.display = 'block';
                title.innerText = "FemDihShop";
                btnLeft.className = "nav-btn left hidden";
                btnRight.className = "nav-btn right";
                renderList();
            }
        }

        // --- 4. FUNCTIONS ---
        function goHome() { window.location.href = "?"; }
        function goRequest() { window.location.href = "?page=request"; }

        function renderList() {
            const container = document.getElementById('app-list-view');
            container.innerHTML = "";
            
            if(myApps.length === 0) {
                container.innerHTML = "<div style='text-align:center; padding:20px; color:#888'>No apps added yet. Go to /?page=admin to add one.</div>";
                return;
            }

            myApps.forEach(app => {
                const item = document.createElement('div');
                item.className = 'app-item';
                item.onclick = (e) => { 
                    if(!e.target.className.includes('get-btn')) {
                        window.location.href = `?id=${app.id}`;
                    }
                };
                
                let iconStyle = "";
                if (app.color && app.color.includes('http')) {
                    iconStyle = `background-image: url('${app.color}'); background-size: cover;`;
                } else {
                    iconStyle = `background: ${app.color};`;
                }
                
                item.innerHTML = `
                    <div class="list-icon" style="${iconStyle}"></div>
                    <div class="info">
                        <div class="title">${app.name}</div>
                        <div class="subtitle">${app.company}</div>
                    </div>
                    <button class="get-btn" onclick="window.location.href='${app.scheme}'">OPEN</button>
                `;
                container.appendChild(item);
            });
        }

        // --- 5. LOGIC & ADMIN ---
        function sendFeedback() {
            const msg = document.getElementById('req-msg').value;
            if(!msg) return alert("Please type something first!");
            
            db.ref('requests').push({
                message: msg,
                date: Date.now()
            });
            alert("Request Sent!");
            goHome();
        }

        function checkLogin() {
            const input = document.getElementById('admin-pin').value;
            if (input === ADMIN_PIN) {
                document.getElementById('admin-login-view').style.display = 'none';
                document.getElementById('admin-dashboard-view').style.display = 'block';
            } else {
                alert("Incorrect PIN");
            }
        }

        function addApp() {
            const name = document.getElementById('new-name').value;
            const id = document.getElementById('new-id').value;
            
            if(!name || !id) return alert("Name and App ID are required!");

            const newApp = {
                name: name,
                company: document.getElementById('new-comp').value,
                id: id,
                scheme: document.getElementById('new-scheme').value,
                desc: document.getElementById('new-desc').value,
                color: document.getElementById('new-color').value
            };
            
            // Save to Firebase using the ID as the Key
            db.ref('apps/' + id).set(newApp, (error) => {
                if (error) {
                    alert("Error: " + error.message);
                } else {
                    alert("App Added Successfully!");
                    goHome();
                }
            });
        }

        function deleteApp() {
            const name = document.getElementById('del-name').value;
            const app = myApps.find(a => a.name === name);
            
            if(!app) return alert("App not found. Type the EXACT name.");
            if(!confirm(`Are you sure you want to delete ${name}?`)) return;

            db.ref('apps/' + app.id).remove()
                .then(() => {
                    alert("App Deleted.");
                    goHome();
                })
                .catch(err => alert(err.message));
        }

        // Initial Run
        handleRouting();
    </script>
</body>
</html>
