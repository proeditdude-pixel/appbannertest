<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>School App Store | Enterprise Edition</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">

    <script type="text/javascript">
        (function() {
            try {
                // 1. Parse the current URL parameters
                var urlParams = new URLSearchParams(window.location.search);
                var targetAppId = urlParams.get('id');

                // 2. Validate that the ID is numeric (Apple IDs are always numbers)
                //    Regex: ^\d+$ ensures string contains only digits 0-9.
                var isNumericId = /^\d+$/.test(targetAppId);

                // 3. Logic Branch
                if (targetAppId && isNumericId) {
                    // 4. Inject the Meta Tag directly into the document stream
                    console.log("[Smart Banner] Injecting meta tag for App ID: " + targetAppId);
                    document.write('<meta name="apple-itunes-app" content="app-id=' + targetAppId + '">');
                } else {
                    console.log("[Smart Banner] No valid numeric App ID found in URL. Banner skipped.");
                }
            } catch (e) {
                console.error("[Smart Banner] Critical Error: ", e);
            }
        })();
    </script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* 3.1 ROOT VARIABLES 
           Defining the design system tokens for consistency.
        */
        :root {
            /* Apple Human Interface Guidelines - Color Palette */
            --ios-blue: #007AFF;
            --ios-blue-rgb: 0, 122, 255;
            --ios-green: #34C759;
            --ios-indigo: #5856D6;
            --ios-orange: #FF9500;
            --ios-pink: #FF2D55;
            --ios-purple: #AF52DE;
            --ios-red: #FF3B30;
            --ios-teal: #5AC8FA;
            --ios-yellow: #FFCC00;
            
            /* System Grays */
            --ios-gray-1: #8E8E93;
            --ios-gray-2: #AEAEB2;
            --ios-gray-3: #C7C7CC;
            --ios-gray-4: #D1D1D6;
            --ios-gray-5: #E5E5EA;
            --ios-gray-6: #F2F2F7;

            /* Backgrounds */
            --bg-body: #F2F2F7;
            --bg-card: #FFFFFF;
            --bg-modal: #FFFFFF;
            --bg-overlay: rgba(0, 0, 0, 0.4);

            /* Text Colors */
            --text-primary: #000000;
            --text-secondary: #8E8E93;
            --text-tertiary: #C7C7CC;
            --text-link: #007AFF;

            /* MDM Specifics */
            --mdm-backdrop: #1c1c1e;
            --mdm-sidebar: #f5f5f7;
            --mdm-border: #d1d1d6;
            
            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;

            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-float: 0 20px 40px rgba(0,0,0,0.2);
        }

        /* 3.2 RESET & BASE STYLES 
        */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden; /* App-like feel, no bounce */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.5;
        }

        a { text-decoration: none; color: inherit; }
        ul { list-style: none; }
        button { border: none; background: none; cursor: pointer; font-family: inherit; font-size: inherit; }
        input, textarea { font-family: inherit; font-size: inherit; border: none; background: none; }

        /* 3.3 UTILITY CLASSES 
        */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { display: flex; flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .font-medium { font-weight: 500; }
        .text-sm { font-size: 13px; }
        .text-xs { font-size: 11px; }
        .text-blue { color: var(--ios-blue); }
        .text-gray { color: var(--text-secondary); }
        .bg-white { background: white; }
        
        /* 3.4 COMPONENT: LOADING SPINNER 
        */
        #global-loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: white;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.4s ease-out;
        }

        .spinner-ring {
            width: 40px;
            height: 40px;
            border: 4px solid var(--ios-gray-5);
            border-top-color: var(--ios-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loader-text {
            margin-top: 20px;
            font-size: 14px;
            font-weight: 600;
            color: var(--ios-gray-1);
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 3.5 THEME: MDM DESKTOP WINDOW 
           Active when body has class "theme-mdm"
        */
        body.theme-mdm {
            background-color: var(--mdm-backdrop);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mdm-window {
            display: none; /* Hidden by default in mobile theme */
            width: 95%;
            max-width: 1100px;
            height: 85vh;
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: var(--shadow-float);
            flex-direction: column;
            overflow: hidden;
            position: relative;
            animation: windowPop 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        body.theme-mdm .mdm-window {
            display: flex;
        }

        @keyframes windowPop {
            0% { transform: scale(0.95); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .mdm-toolbar {
            height: 55px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--mdm-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 20;
        }

        .mdm-title {
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mdm-actions {
            display: flex;
            gap: 12px;
        }

        .mdm-btn {
            height: 28px;
            padding: 0 12px;
            border-radius: 6px;
            border: 1px solid var(--ios-gray-3);
            background: white;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }

        .mdm-btn:hover {
            background: var(--ios-gray-6);
            border-color: var(--ios-gray-2);
        }
        
        .mdm-btn:active {
            background: var(--ios-gray-5);
            transform: scale(0.98);
        }

        .mdm-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* MDM List Table */
        .app-table-container {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background: white;
        }

        .app-table {
            width: 100%;
            border-collapse: collapse;
        }

        .app-table thead th {
            text-align: left;
            padding: 10px 20px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--ios-gray-5);
            background: rgba(255, 255, 255, 0.98);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .app-table tbody tr {
            border-bottom: 1px solid var(--ios-gray-6);
            cursor: pointer;
            transition: background 0.15s;
        }

        .app-table tbody tr:hover {
            background-color: var(--ios-gray-6);
        }

        .app-table td {
            padding: 12px 20px;
            vertical-align: middle;
            font-size: 14px;
            color: var(--text-primary);
        }

        .table-icon-box {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background-color: var(--ios-gray-5);
            background-size: cover;
            background-position: center;
            border: 1px solid rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-weight: bold;
            font-size: 14px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            background: var(--ios-gray-6);
            color: var(--ios-blue);
            font-size: 11px;
            font-weight: 700;
            border-radius: 12px;
            letter-spacing: 0.5px;
        }

        /* 3.6 THEME: CLASSIC MOBILE 
           Active when body does NOT have "theme-mdm"
        */
        .mobile-shell {
            display: none; /* Hidden if MDM theme is active */
            flex-direction: column;
            height: 100%;
            width: 100%;
            background: var(--bg-card);
        }

        body:not(.theme-mdm) .mobile-shell {
            display: flex;
        }

        .mobile-nav {
            height: 60px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--ios-gray-5);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .mobile-brand {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .mobile-tools {
            display: flex;
            gap: 16px;
            color: var(--ios-blue);
        }
        
        .mobile-icon-btn {
            font-size: 22px;
            cursor: pointer;
        }

        .mobile-list {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .mobile-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--ios-gray-6);
            cursor: pointer;
            active-background: var(--ios-gray-6);
        }

        .mobile-item:active {
            background-color: var(--ios-gray-6);
        }

        .mobile-item-icon {
            width: 58px;
            height: 58px;
            border-radius: 12px;
            background-color: var(--ios-gray-5);
            background-size: cover;
            background-position: center;
            border: 1px solid rgba(0,0,0,0.1);
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            font-weight: 700;
        }

        .mobile-item-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .mobile-item-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .mobile-item-sub {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .mobile-get-btn {
            background: var(--ios-gray-6);
            color: var(--ios-blue);
            font-weight: 700;
            font-size: 13px;
            padding: 6px 18px;
            border-radius: 16px;
            text-transform: uppercase;
        }

        /* 3.7 DETAIL VIEW (SHARED COMPONENT)
           This overlay appears in both Mobile and MDM views.
        */
        .detail-view {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: white;
            z-index: 100;
            display: none; /* Hidden initially */
            flex-direction: column;
            overflow-y: auto;
            animation: slideUp 0.35s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .detail-header {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--ios-blue);
            font-weight: 500;
            cursor: pointer;
            position: sticky;
            top: 0;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .detail-container {
            max-width: 700px;
            margin: 0 auto;
            padding: 10px 20px 60px 20px;
            width: 100%;
        }

        .app-hero {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .app-hero-icon {
            width: 110px;
            height: 110px;
            border-radius: 24px;
            background-color: var(--ios-gray-5);
            background-size: cover;
            background-position: center;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(0,0,0,0.1);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
            font-weight: 700;
        }

        .app-hero-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 5px 0;
        }

        .app-hero-title {
            font-size: 22px;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 5px;
        }

        .app-hero-dev {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .install-action-btn {
            background-color: var(--ios-blue);
            color: white;
            font-weight: 700;
            font-size: 14px;
            padding: 8px 24px;
            border-radius: 20px;
            text-align: center;
            width: fit-content;
            transition: transform 0.1s;
        }

        .install-action-btn:active {
            transform: scale(0.96);
            opacity: 0.9;
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-top: 1px solid var(--ios-gray-5);
            border-bottom: 1px solid var(--ios-gray-5);
            margin-bottom: 25px;
        }

        .stat-block {
            flex: 1;
            text-align: center;
            border-right: 1px solid var(--ios-gray-6);
        }
        
        .stat-block:last-child {
            border-right: none;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--ios-gray-1);
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--ios-gray-2);
            text-transform: uppercase;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin: 25px 0 10px 0;
            color: var(--text-primary);
        }

        .text-body {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        /* Comments Area */
        .comments-wrapper {
            margin-top: 20px;
            border-top: 1px solid var(--ios-gray-5);
            padding-top: 20px;
        }

        .review-card {
            background: var(--ios-gray-6);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .review-user {
            font-weight: 700;
            font-size: 14px;
        }

        .review-date {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .review-text {
            font-size: 14px;
            line-height: 1.4;
            color: var(--text-primary);
        }

        .review-input-box {
            background: white;
            border: 1px solid var(--ios-gray-4);
            border-radius: 8px;
            padding: 12px;
            width: 100%;
            font-size: 14px;
            margin-bottom: 10px;
            resize: none;
        }
        
        .review-input-box:focus {
            border-color: var(--ios-blue);
        }

        /* 3.8 MODALS (ADMIN & REPORT) 
        */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-overlay);
            z-index: 5000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-card {
            background: white;
            width: 90%;
            max-width: 420px;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-float);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-overlay.active .modal-card {
            transform: scale(1);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
            display: block;
            text-transform: uppercase;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: var(--ios-gray-6);
            border: 1px solid transparent;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.2s, background 0.2s;
        }

        .form-input:focus {
            background: white;
            border-color: var(--ios-blue);
        }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: var(--ios-blue);
            color: white;
            font-weight: 600;
            border-radius: 10px;
            font-size: 16px;
            margin-top: 10px;
        }

        .btn-primary:active {
            opacity: 0.8;
        }

        .btn-text {
            width: 100%;
            padding: 10px;
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 5px;
        }

        /* Admin List Row */
        .admin-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--ios-gray-6);
        }

        .admin-delete-btn {
            color: var(--ios-red);
            font-size: 13px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255, 59, 48, 0.1);
        }

        /* 3.9 RESPONSIVE ADJUSTMENTS 
        */
        @media (min-width: 768px) {
            /* Adjust modal size for larger screens */
            .modal-card {
                max-width: 500px;
                padding: 30px;
            }
        }
    </style>
</head>
<body class="theme-mdm"> <div id="global-loader">
        <div class="spinner-ring"></div>
        <div class="loader-text">Loading Store...</div>
    </div>

    <div class="mdm-window">
        <div class="mdm-toolbar">
            <div class="mdm-title">
                <i class="ph ph-squares-four" style="font-size:20px; color:var(--ios-blue);"></i>
                <span>School MDM Console</span>
            </div>
            <div class="mdm-actions">
                <button class="mdm-btn" onclick="Utils.toggleTheme()">
                    <i class="ph ph-sun"></i> Theme
                </button>
                <button class="mdm-btn" onclick="Modals.openReport()">
                    <i class="ph ph-warning-circle"></i> Report
                </button>
            </div>
        </div>

        <div class="mdm-content">
            <div id="mdm-list-container" class="app-table-container">
                <table class="app-table">
                    <thead>
                        <tr>
                            <th width="80">Icon</th>
                            <th>Application Name</th>
                            <th>Version</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="mdm-table-body">
                        </tbody>
                </table>
            </div>

            <div id="mdm-detail-view" class="detail-view">
                </div>
        </div>
    </div>

    <div class="mobile-shell">
        <div class="mobile-nav">
            <div class="mobile-brand">FemDihShop</div>
            <div class="mobile-tools">
                <i class="ph ph-sun mobile-icon-btn" onclick="Utils.toggleTheme()"></i>
                <i class="ph ph-warning-circle mobile-icon-btn" onclick="Modals.openReport()"></i>
            </div>
        </div>
        
        <div id="mobile-list-container" class="mobile-list">
            </div>

        <div id="mobile-detail-view" class="detail-view" style="z-index: 200;">
            </div>
    </div>

    <div id="modal-report" class="modal-overlay">
        <div class="modal-card">
            <h3 class="modal-title">Report Issue</h3>
            <p style="text-align:center; color:var(--text-secondary); margin-bottom:20px; font-size:14px;">
                Found a bug or broken link? Let the administrator know directly.
            </p>
            
            <div class="form-group">
                <textarea id="report-input" class="form-input" rows="5" placeholder="Describe the problem..."></textarea>
            </div>

            <button class="btn-primary" onclick="Logic.submitReport()">Send Report</button>
            <button class="btn-text" onclick="Modals.closeReport()">Cancel</button>
        </div>
    </div>

    <div id="modal-login" class="modal-overlay">
        <div class="modal-card" style="text-align:center;">
            <div style="width:60px; height:60px; background:var(--ios-gray-6); border-radius:50%; display:inline-flex; align-items:center; justify-content:center; margin-bottom:15px;">
                <i class="ph ph-lock-key" style="font-size:30px; color:var(--text-secondary);"></i>
            </div>
            <h3 class="modal-title">Admin Access</h3>
            <p style="color:var(--text-secondary); font-size:14px; margin-bottom:20px;">
                Authorized personnel only.
            </p>
            
            <div class="form-group">
                <input type="password" id="login-pin" class="form-input" style="text-align:center; letter-spacing:5px; font-size:24px;" maxlength="4" placeholder="••••">
            </div>

            <button class="btn-primary" onclick="Logic.attemptLogin()">Unlock Dashboard</button>
            <button class="btn-text" onclick="Utils.goHome()">Exit Store</button>
        </div>
    </div>

    <div id="modal-dashboard" class="modal-overlay" style="align-items: flex-start; overflow-y:auto;">
        <div class="modal-card" style="margin-top:40px; max-width:600px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="modal-title" style="margin:0;">Manager Dashboard</h3>
                <button class="btn-text" style="width:auto; color:var(--ios-red);" onclick="Utils.goHome()">Logout</button>
            </div>

            <div style="background:var(--ios-gray-6); border-radius:12px; padding:20px; margin-bottom:20px;">
                <h4 style="margin-bottom:15px; font-weight:700;">Add New Application</h4>
                
                <div class="form-group">
                    <label class="form-label">Apple App ID (Numbers Only)</label>
                    <input id="add-id" class="form-input bg-white" placeholder="e.g. 1053012308">
                    <div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">
                        Required for Smart Banner.
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">App Name</label>
                    <input id="add-name" class="form-input bg-white" placeholder="e.g. Minecraft">
                </div>

                <div class="form-group">
                    <label class="form-label">URL Scheme</label>
                    <input id="add-scheme" class="form-input bg-white" placeholder="e.g. minecraft://">
                    <div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">
                        Type name above to auto-detect if possible.
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Custom Icon URL (Optional)</label>
                    <input id="add-icon" class="form-input bg-white" placeholder="https://...">
                </div>

                <button class="btn-primary" onclick="Logic.addApp()">Save to Database</button>
            </div>

            <div style="border-top:1px solid var(--ios-gray-4); padding-top:20px; margin-bottom:20px;">
                <h4 style="margin-bottom:10px; font-weight:700;">Installed Apps</h4>
                <div id="admin-app-list" style="max-height:200px; overflow-y:auto; border:1px solid var(--ios-gray-4); border-radius:8px; padding:0 10px; background:white;">
                    <div style="padding:20px; text-align:center; color:gray;">Loading list...</div>
                </div>
            </div>

            <div style="border-top:1px solid var(--ios-gray-4); padding-top:20px;">
                <h4 style="margin-bottom:10px; font-weight:700;">User Reports</h4>
                <div id="admin-report-list" style="font-size:13px; color:var(--text-secondary);">
                    Loading...
                </div>
            </div>
        </div>
    </div>


    <script>
        /**
         * 5.1 CONFIGURATION & CONSTANTS
         */
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDGi1smvUpUmw76Qrc0XWLRDDgpfEZAEDA",
            authDomain: "schoolappdownload.firebaseapp.com",
            databaseURL: "https://schoolappdownload-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "schoolappdownload",
            storageBucket: "schoolappdownload.firebasestorage.app",
            messagingSenderId: "386507255292",
            appId: "1:386507255292:web:c20e841b39538c43251679"
        };

        const ADMIN_PIN = "1234";

        /**
         * 5.2 APP SCHEME DATABASE
         * This massive list helps the admin quickly find the URL scheme for popular apps.
         * Used in the Admin Panel logic.
         */
        const SCHEME_DB = {
            "minecraft": "minecraft://",
            "roblox": "robloxmobile://",
            "zoom": "zoomus://",
            "chrome": "googlechrome://",
            "gmail": "googlegmail://",
            "youtube": "youtube://",
            "docs": "googledocs://",
            "sheets": "googlesheets://",
            "slides": "googleslides://",
            "drive": "googledrive://",
            "spotify": "spotify://",
            "netflix": "nflx://",
            "disney": "disneyplus://",
            "hulu": "hulu://",
            "twitch": "twitch://",
            "discord": "discord://",
            "twitter": "twitter://",
            "instagram": "instagram://",
            "facebook": "fb://",
            "messenger": "fb-messenger://",
            "whatsapp": "whatsapp://",
            "telegram": "tg://",
            "snapchat": "snapchat://",
            "tiktok": "tiktok://",
            "pinterest": "pinterest://",
            "reddit": "reddit://",
            "tumblr": "tumblr://",
            "linkedin": "linkedin://",
            "soundcloud": "soundcloud://",
            "waze": "waze://",
            "maps": "comgooglemaps://",
            "uber": "uber://",
            "lyft": "lyft://",
            "amazon": "amazon://",
            "ebay": "ebay://",
            "paypal": "paypal://",
            "venmo": "venmo://",
            "cashapp": "squarecash://",
            "dropbox": "dropbox://",
            "evernote": "evernote://",
            "notion": "notion://",
            "slack": "slack://",
            "trello": "trello://",
            "teams": "msteams://",
            "outlook": "ms-outlook://",
            "onedrive": "ms-onedrive://",
            "word": "ms-word://",
            "excel": "ms-excel://",
            "powerpoint": "ms-powerpoint://",
            "onenote": "onenote://",
            "clash royale": "clashroyale://",
            "clash of clans": "clashofclans://",
            "brawl stars": "brawlstars://",
            "hay day": "hayday://",
            "pubg": "pubgmobile://",
            "cod mobile": "codm://",
            "genshin": "genshinimpact://",
            "honkai": "honkaistarrail://",
            "among us": "amongus://",
            "subway surfers": "subwaysurfers://",
            "candy crush": "candycrush://",
            "pokemon go": "pokemongo://",
            "mario kart": "mariokarttour://",
            "duolingo": "duolingo://",
            "kahoot": "kahoot://",
            "quizlet": "quizlet://",
            "canvas": "canvas-student://",
            "blackboard": "blackboard://",
            "classroom": "googleclassroom://",
            "settings": "App-prefs://",
            "shortcuts": "shortcuts://",
            "files": "shareddocuments://",
            "photos": "photos-redirect://",
            "camera": "camera://",
            "calculator": "calc://",
            "calendar": "calshow://",
            "music": "music://",
            "wallet": "shoebox://",
            "health": "x-apple-health://",
            "books": "ibooks://",
            "podcasts": "podcasts://",
            "tv": "videos://",
            "news": "applenews://",
            "stocks": "stocks://",
            "weather": "weather://",
            "facetime": "facetime://",
            "messages": "sms://",
            "phone": "tel://",
            "mail": "mailto://",
            "safari": "x-web-search://"
        };


        /**
         * 5.3 GLOBAL STATE MANAGEMENT
         */
        const State = {
            apps: [],
            currentAppId: null,
            isAdmin: false,
            dbRef: null
        };


        /**
         * 5.4 UTILITY CLASS
         * Helper functions for formatting, navigation, and theme control.
         */
        const Utils = {
            // Toggle between MDM and Mobile styles
            toggleTheme: () => {
                const body = document.body;
                if (body.classList.contains('theme-mdm')) {
                    body.classList.remove('theme-mdm');
                    localStorage.setItem('school_store_theme', 'classic');
                } else {
                    body.classList.add('theme-mdm');
                    localStorage.setItem('school_store_theme', 'mdm');
                }
                // If detail view is open, reload to ensure correct layout structure is used
                if (window.location.search.includes('id=')) {
                    window.location.reload();
                }
            },

            // Check saved theme preference on load
            initTheme: () => {
                const saved = localStorage.getItem('school_store_theme');
                const isMobileScreen = window.innerWidth < 768;
                
                if (saved === 'classic') {
                    document.body.classList.remove('theme-mdm');
                } else if (saved === 'mdm') {
                    document.body.classList.add('theme-mdm');
                } else if (isMobileScreen) {
                    // Default to classic on small screens if no preference
                    document.body.classList.remove('theme-mdm');
                }
            },

            // Navigate Home
            goHome: () => {
                window.location.href = window.location.pathname;
            },

            // Reload Page with specific ID (for banner trigger)
            reloadWithId: (id) => {
                window.location.href = '?id=' + id;
            },

            // Format date to readable string
            formatDate: (timestamp) => {
                return new Date(timestamp).toLocaleDateString(undefined, {
                    month: 'short', day: 'numeric', year: 'numeric'
                });
            },

            // Hide the global loader
            hideLoader: () => {
                const loader = document.getElementById('global-loader');
                if (loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.style.display = 'none', 400);
                }
            }
        };


        /**
         * 5.5 MODAL CONTROLLER
         * Handles opening and closing of overlays.
         */
        const Modals = {
            openReport: () => {
                document.getElementById('modal-report').classList.add('active');
            },
            closeReport: () => {
                document.getElementById('modal-report').classList.remove('active');
            },
            
            openLogin: () => {
                document.getElementById('modal-login').classList.add('active');
            },
            closeLogin: () => {
                document.getElementById('modal-login').classList.remove('active');
            },

            openDashboard: () => {
                document.getElementById('modal-dashboard').classList.add('active');
                Logic.fetchAdminData(); // Start listening for admin data
            },
            closeDashboard: () => {
                document.getElementById('modal-dashboard').classList.remove('active');
            }
        };


        /**
         * 5.6 CORE LOGIC CLASS
         * Main application logic for fetching data, rendering UI, and handling user input.
         */
        const Logic = {
            // Initialize Firebase
            init: () => {
                if (!firebase.apps.length) {
                    firebase.initializeApp(FIREBASE_CONFIG);
                }
                State.dbRef = firebase.database();
                
                // Determine route
                const params = new URLSearchParams(window.location.search);
                const page = params.get('page');
                const id = params.get('id');

                Utils.initTheme();

                if (page === 'admin') {
                    Utils.hideLoader();
                    Modals.openLogin();
                } else {
                    Logic.startAppListener(id);
                }
            },

            // Listen for App Data Changes
            startAppListener: (targetId) => {
                State.dbRef.ref('apps').on('value', (snapshot) => {
                    const val = snapshot.val();
                    State.apps = val ? Object.values(val) : [];
                    
                    // Render Lists
                    Logic.renderMDMList();
                    Logic.renderMobileList();
                    
                    Utils.hideLoader();

                    // If ID exists in URL, open that app
                    if (targetId) {
                        Logic.openAppDetail(targetId);
                    }
                });
            },

            // Render Desktop Table
            renderMDMList: () => {
                const tbody = document.getElementById('mdm-table-body');
                tbody.innerHTML = '';
                
                State.apps.forEach(app => {
                    const tr = document.createElement('tr');
                    tr.onclick = () => Utils.reloadWithId(app.id);
                    
                    // Icon logic
                    let iconHtml = '';
                    if (app.icon && app.icon.startsWith('http')) {
                        iconHtml = `<div class="table-icon-box" style="background-image: url('${app.icon}')"></div>`;
                    } else {
                        iconHtml = `<div class="table-icon-box" style="background-color: ${Logic.getColor(app.name)}">${app.name.charAt(0)}</div>`;
                    }

                    tr.innerHTML = `
                        <td>${iconHtml}</td>
                        <td class="font-medium">${app.name}</td>
                        <td class="text-gray">${app.version || '1.0'}</td>
                        <td><span class="status-badge">INSTALLED</span></td>
                    `;
                    tbody.appendChild(tr);
                });
            },

            // Render Mobile List
            renderMobileList: () => {
                const container = document.getElementById('mobile-list-container');
                container.innerHTML = '';

                State.apps.forEach(app => {
                    const div = document.createElement('div');
                    div.className = 'mobile-item';
                    div.onclick = () => Utils.reloadWithId(app.id);

                    // Icon Logic
                    let iconStyle = '';
                    let iconInner = '';
                    if (app.icon && app.icon.startsWith('http')) {
                        iconStyle = `background-image: url('${app.icon}');`;
                    } else {
                        iconStyle = `background-color: ${Logic.getColor(app.name)};`;
                        iconInner = app.name.charAt(0);
                    }

                    div.innerHTML = `
                        <div class="mobile-item-icon" style="${iconStyle}">${iconInner}</div>
                        <div class="mobile-item-content">
                            <div class="mobile-item-title">${app.name}</div>
                            <div class="mobile-item-sub">Education • Installed</div>
                        </div>
                        <div class="mobile-get-btn">OPEN</div>
                    `;
                    container.appendChild(div);
                });
            },

            // Generate a persistent color based on string
            getColor: (str) => {
                const colors = ['#FF3B30', '#FF9500', '#FFCC00', '#34C759', '#5AC8FA', '#007AFF', '#5856D6', '#AF52DE'];
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    hash = str.charCodeAt(i) + ((hash << 5) - hash);
                }
                return colors[Math.abs(hash) % colors.length];
            },

            // Open Detail View & Fetch Apple Data
            openAppDetail: async (id) => {
                const app = State.apps.find(a => a.id === id);
                if (!app) return; // Stop if app doesn't exist in DB

                // 1. Fetch Real Data from iTunes
                let appleData = {};
                if (/^\d+$/.test(id)) {
                    try {
                        const res = await fetch(`https://itunes.apple.com/lookup?id=${id}`);
                        const json = await res.json();
                        if (json.results && json.results.length > 0) {
                            appleData = json.results[0];
                        }
                    } catch (e) {
                        console.error("Apple Fetch Error:", e);
                    }
                }

                // 2. Prepare Data Variables
                const name = app.name;
                const dev = appleData.artistName || "School Department";
                const desc = appleData.description ? appleData.description.replace(/\n/g, '<br>') : "No description available.";
                const version = appleData.version || app.version || "1.0";
                const rating = appleData.averageUserRating ? appleData.averageUserRating.toFixed(1) : "4.5";
                const icon = appleData.artworkUrl512 || app.icon;
                const scheme = app.scheme || "#";

                // 3. Render HTML
                const detailHTML = `
                    <div class="detail-header" onclick="Utils.goHome()">
                        <i class="ph ph-caret-left-bold" style="font-size:20px;"></i>
                        <span>Back</span>
                    </div>
                    
                    <div class="detail-container">
                        <div class="app-hero">
                            <div class="app-hero-icon" style="${icon && icon.includes('http') ? `background-image:url('${icon}')` : `background-color:${Logic.getColor(name)}`}">${icon && icon.includes('http') ? '' : name[0]}</div>
                            <div class="app-hero-info">
                                <div class="app-hero-title">${name}</div>
                                <div class="app-hero-dev">${dev}</div>
                                <a href="${scheme}" class="install-action-btn">OPEN APP</a>
                            </div>
                        </div>

                        <div class="stats-bar">
                            <div class="stat-block">
                                <div class="stat-value">${rating} ★</div>
                                <div class="stat-label">Rating</div>
                            </div>
                            <div class="stat-block">
                                <div class="stat-value">4+</div>
                                <div class="stat-label">Age</div>
                            </div>
                            <div class="stat-block">
                                <div class="stat-value">${version}</div>
                                <div class="stat-label">Version</div>
                            </div>
                        </div>

                        <div class="section-title">About</div>
                        <div class="text-body">${desc}</div>

                        <div class="section-title">Reviews</div>
                        <div id="comments-container-${id}">
                            <div style="color:gray; font-size:14px;">Loading reviews...</div>
                        </div>

                        <div class="comments-wrapper">
                            <div style="font-weight:600; margin-bottom:10px;">Write a Review</div>
                            <textarea id="review-input-${id}" class="review-input-box" rows="3" placeholder="Review as User..."></textarea>
                            <button class="install-action-btn" onclick="Logic.postComment('${id}')" style="width:100%;">Submit Review</button>
                        </div>
                    </div>
                `;

                // 4. Inject into correct container
                const isMDM = document.body.classList.contains('theme-mdm');
                const containerId = isMDM ? 'mdm-detail-view' : 'mobile-detail-view';
                const listId = isMDM ? 'mdm-list-container' : 'mobile-list-container';

                // Hide list, show detail
                document.getElementById(listId).style.display = 'none';
                const view = document.getElementById(containerId);
                view.innerHTML = detailHTML;
                view.style.display = 'flex';

                // 5. Load Comments
                Logic.loadComments(id);
            },

            /**
             * 5.7 COMMENT SYSTEM
             */
            loadComments: (appId) => {
                const box = document.getElementById(`comments-container-${appId}`);
                if (!box) return;

                State.dbRef.ref(`comments/${appId}`).on('value', snap => {
                    const val = snap.val();
                    if (!val) {
                        box.innerHTML = `<div style="padding:10px 0; color:#888;">No reviews yet. Be the first!</div>`;
                        return;
                    }

                    let html = '';
                    Object.values(val).reverse().forEach(c => {
                        html += `
                            <div class="review-card">
                                <div class="review-header">
                                    <span class="review-user">${c.user}</span>
                                    <span class="review-date">${Utils.formatDate(c.date)}</span>
                                </div>
                                <div class="review-text">${c.text}</div>
                            </div>
                        `;
                    });
                    box.innerHTML = html;
                });
            },

            postComment: (appId) => {
                const input = document.getElementById(`review-input-${appId}`);
                const text = input.value.trim();
                
                if (!text) {
                    alert("Please write something.");
                    return;
                }

                State.dbRef.ref(`comments/${appId}`).push({
                    user: "User",
                    text: text,
                    date: Date.now()
                });
                
                input.value = ""; // Clear
            },

            /**
             * 5.8 REPORTING SYSTEM
             */
            submitReport: () => {
                const txt = document.getElementById('report-input').value.trim();
                if (!txt) {
                    alert("Please describe the issue.");
                    return;
                }

                State.dbRef.ref('requests').push({
                    msg: txt,
                    date: Date.now()
                }).then(() => {
                    alert("Report sent to admin.");
                    document.getElementById('report-input').value = "";
                    Modals.closeReport();
                });
            },

            /**
             * 5.9 ADMIN LOGIC
             */
            attemptLogin: () => {
                const pin = document.getElementById('login-pin').value;
                if (pin === ADMIN_PIN) {
                    Modals.closeLogin();
                    Modals.openDashboard();
                } else {
                    alert("Incorrect PIN");
                    document.getElementById('login-pin').value = "";
                }
            },

            // Auto-complete URL scheme when typing name
            setupAdminListeners: () => {
                const nameInput = document.getElementById('add-name');
                nameInput.addEventListener('input', (e) => {
                    const val = e.target.value.toLowerCase();
                    const schemeInput = document.getElementById('add-scheme');
                    
                    // Lookup in SCHEME_DB
                    for (const [key, scheme] of Object.entries(SCHEME_DB)) {
                        if (val.includes(key)) {
                            schemeInput.value = scheme;
                            break;
                        }
                    }
                });
            },

            addApp: () => {
                const id = document.getElementById('add-id').value.trim();
                const name = document.getElementById('add-name').value.trim();
                const scheme = document.getElementById('add-scheme').value.trim();
                const icon = document.getElementById('add-icon').value.trim();

                if (!id || !name) {
                    alert("ID and Name are required.");
                    return;
                }

                State.dbRef.ref(`apps/${id}`).set({
                    id: id,
                    name: name,
                    scheme: scheme,
                    icon: icon,
                    addedAt: Date.now()
                }).then(() => {
                    alert("App Added!");
                    // Clear fields
                    document.getElementById('add-id').value = "";
                    document.getElementById('add-name').value = "";
                    document.getElementById('add-scheme').value = "";
                    document.getElementById('add-icon').value = "";
                });
            },

            deleteApp: (id) => {
                if (confirm("Are you sure you want to delete this app?")) {
                    State.dbRef.ref(`apps/${id}`).remove();
                }
            },

            dismissReport: (key) => {
                State.dbRef.ref(`requests/${key}`).remove();
            },

            fetchAdminData: () => {
                // Setup auto-complete listeners once
                Logic.setupAdminListeners();

                // Listen to App List for Management
                State.dbRef.ref('apps').on('value', snap => {
                    const list = document.getElementById('admin-app-list');
                    list.innerHTML = '';
                    
                    const val = snap.val();
                    if (!val) {
                        list.innerHTML = '<div style="padding:15px; text-align:center;">No apps found.</div>';
                        return;
                    }

                    Object.values(val).forEach(app => {
                        const div = document.createElement('div');
                        div.className = 'admin-item-row';
                        div.innerHTML = `
                            <div>
                                <div style="font-weight:600; font-size:14px;">${app.name}</div>
                                <div style="font-size:11px; color:gray;">ID: ${app.id}</div>
                            </div>
                            <div class="admin-delete-btn" onclick="Logic.deleteApp('${app.id}')">Delete</div>
                        `;
                        list.appendChild(div);
                    });
                });

                // Listen to Reports
                State.dbRef.ref('requests').on('value', snap => {
                    const box = document.getElementById('admin-report-list');
                    box.innerHTML = '';
                    
                    const val = snap.val();
                    if (!val) {
                        box.innerHTML = 'No pending reports.';
                        return;
                    }

                    Object.entries(val).forEach(([key, data]) => {
                        const div = document.createElement('div');
                        div.style.padding = '10px 0';
                        div.style.borderBottom = '1px solid #eee';
                        div.innerHTML = `
                            <div style="margin-bottom:4px; font-style:italic;">"${data.msg}"</div>
                            <div style="display:flex; justify-content:space-between; font-size:11px; color:gray;">
                                <span>${Utils.formatDate(data.date)}</span>
                                <span style="color:red; cursor:pointer; font-weight:600;" onclick="Logic.dismissReport('${key}')">Dismiss</span>
                            </div>
                        `;
                        box.appendChild(div);
                    });
                });
            }
        };

        // 6. START APPLICATION
        window.onload = function() {
            Logic.init();
        };

    </script>
</body>
</html>
